# Cron 時刻対応表

## スケジュール一覧

| ジョブ | Cron 式 (UTC) | 実行時刻 (JST) | 説明 |
|--------|--------------|----------------|------|
| Cron A | `40 9 * * *` | 18:40 | 日次確定データ |
| Cron B | `20 10 * * *` | 19:20 | 決算発表予定 |
| Cron C | `10 3 * * *` | 12:10 | 投資部門別 + 整合性チェック |
| Cron D | `0 22 * * 0-4` | 07:00 (月〜金) | マクロ経済指標 (FRED/e-Stat) |

> **注意**: GitHub Actions の cron は UTC で指定。JST = UTC + 9時間

## Cron A: 日次確定データ

**実行時刻**: 毎日 JST 18:40

**処理内容**: 前営業日の確定データを順次取得

| 順序 | データセット | 説明 |
|------|--------------|------|
| 1 | `calendar` | 取引カレンダー（±370日） |
| 2 | `equity_bars` | 株価日足（全銘柄） |
| 3 | `topix` | TOPIX 日足 |
| 4 | `financial` | 財務サマリー |
| 5 | `equity_master` | 銘柄マスタスナップショット |

**設計意図**:
- J-Quants API の株価四本値は 16:30 頃、財務速報は 18:00 頃に更新
- 18:40 は両方が揃った後のタイミングで、当日中にデータ取り込みを完了

**キャッチアップ**:
- 最大 5 営業日分の漏れを自動検出・取得
- 土日祝の次の営業日には、金曜分を取得

## Cron B: 決算発表予定

**実行時刻**: 毎日 JST 19:20

**処理内容**: 翌営業日の決算発表予定を取得

| データセット | 説明 |
|--------------|------|
| `earnings_calendar` | 翌営業日の決算発表予定企業一覧 |

**設計意図**:
- API は常に「翌営業日」の発表予定を返す
- 土日祝も実行（金曜失敗時のリカバリ対応）
- 翌日の決算発表に備えて夕方に取得

## Cron C: 投資部門別 + 整合性チェック

**実行時刻**: 毎日 JST 12:10

**処理内容**:

| 順序 | データセット | 説明 |
|------|--------------|------|
| 1 | `investor_types` | 投資部門別売買動向（過去60日） |
| 2 | `integrity_check` | データ整合性チェック |

**スライディングウィンドウ方式**:
- 過去 60 日分を毎回取得（環境変数 `INVESTOR_TYPES_WINDOW_DAYS` で調整可能）
- 週次公表データの訂正・再公表に自動対応
- `published_date` を主キーに含めることで訂正版を別レコードとして保存

**整合性チェック項目**:
- 取引カレンダーが ±370 日をカバーしているか
- 株価データの最新日が 3 日以内か
- TOPIX データの最新日が 3 日以内か

## Cron D: マクロ経済指標

**実行時刻**: 月〜金 JST 07:00 (UTC 日〜木 22:00)

**処理内容**: FRED API / e-Stat API からマクロ経済指標を取得

| ソース | 系列数 | 主な指標 |
|--------|--------|----------|
| FRED | 14 | ISM PMI, 失業率, FF金利, VIX, HYスプレッド, USD/JPY 等 |
| e-Stat | 2 | 景気動向指数CI先行, コアCPI |

**実行方式**:
- GitHub Actions Runner で直接実行（Vercel 経由せず）
- `npx tsx scripts/cron/cron-d-direct.ts` を実行
- Vercel の 10 秒制限を回避するため、GitHub Actions で最大 15 分まで実行可能

**設計意図**:
- 米国市場閉場後（UTC 21:00 = JST 06:00）に FRED データが更新
- 1時間のマージンを取って JST 07:00 に実行
- 日本の朝に最新の米国経済指標を取り込み、当日の投資判断に活用

**手動実行オプション**:
- `source`: `all` / `fred` / `estat` から選択
- `backfill_days`: 過去N日分をバックフィル（0=差分のみ）

## 時刻選定の理由

### Cron A (18:40)
- J-Quants API の株価四本値は 16:30 頃、財務速報は 18:00 頃に更新
- 両方が確実に揃った 18:40 に実行し、当日中にデータ取り込みを完了
- 翌朝の市場開始前に最新データが利用可能な状態にする

### Cron B (19:20)
- 大引け（15:00）後、決算発表は 15:00～18:00 に集中
- 翌日の決算予定は夕方以降に確定
- 19:00 以降に取得して翌日の準備

### Cron C (12:10)
- 日中の負荷が比較的低い時間帯
- 投資部門別は週次公表のため即時性不要
- 整合性チェックを日次で実施

### Cron D (07:00 月〜金)
- 米国市場閉場後（JST 06:00）に FRED データが更新
- 1時間のマージンで安定した取得
- 日本の朝に最新指標を反映し、当日の投資判断に活用

## 手動実行

GitHub Actions の **workflow_dispatch** で手動実行が可能。

1. リポジトリの **Actions** タブを開く
2. 対象のワークフローを選択
3. **Run workflow** ボタンをクリック

## 障害時の挙動

| 状況 | 対応 |
|------|------|
| API 一時エラー | 指数バックオフでリトライ |
| 完全失敗 | 失敗通知メール送信 |
| 翌日の Cron 実行 | キャッチアップで漏れを検出・再取得 |
